name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  php-lint:
    name: PHP Syntax Check
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'

      - name: Check PHP syntax
        run: |
          echo "Checking PHP syntax for all PHP files..."
          FILES=$(find . -name "*.php" -not -path "*/vendor/*" -not -path "./.git/*")

          if [ -z "$FILES" ]; then
            echo "⚠ No PHP files found to check"
            exit 0
          fi

          FILE_COUNT=$(echo "$FILES" | wc -l)
          echo "Found $FILE_COUNT PHP file(s) to check"

          ERROR_COUNT=0
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              if ! php -l "$file" > /dev/null 2>&1; then
                echo "✗ Syntax error in: $file"
                php -l "$file"
                ERROR_COUNT=$((ERROR_COUNT + 1))
              fi
            fi
          done <<< "$FILES"

          if [ $ERROR_COUNT -eq 0 ]; then
            echo "✓ All PHP files have valid syntax"
            exit 0
          else
            echo "✗ Found $ERROR_COUNT file(s) with syntax errors"
            exit 1
          fi
